# 工作总结

**日期**：2026年2月2日（含当日多会话）  
**项目**：EcoLens (ADProject-main)

本文档汇总**今日**在食物记录、数据库迁移、登录 500、前后端环境与部署等方面的工作（根据对话与代码变更整理）。

---

## 一、版本控制与分支

- **合并远程 main 到本地 xuwenzhe**（多次）
  - 使用 `git fetch origin` 后 `git merge origin/main`；存在未提交改动时先 `git stash`，合并后再 `git stash pop`。
- **删除无用文件**
  - `Migrations/FixMigrationHistory.sql`、`Migrations/CreateFoodRecordsTable.sql`（迁移已幂等化 / 接口内自动建表，不再需要手动脚本）。
- **推送到远程 main**
  - 食物记录 500 修复、迁移幂等化、EF 关系修复等：在 xuwenzhe 提交后合并到 main 并 push。
  - 食物 amount 按克（g）接收、后端 /1000 转 kg：提交后合并到 main 并 push。
  - 数据库迁移相关：新增迁移与启动时 `Migrate()`，提交后合并到 main 并 push，触发 GitHub Actions 部署。
  - 迁移成功后清理：移除启动时 `Migrate()` 与 `fix-applicationusers-azure.sql`，提交后合并到 main 并 push。
- **合并 main 最新到本地 xuwenzhe**
  - 多次执行 `git merge origin/main`，将远程 main 上的 AuthController、敏感词服务（ISensitiveWordService、SensitiveWordService）、FoodRecordsController、LogMeal、LogTravel、TravelService、GoogleMapsService 等变更合入本地 xuwenzhe。

---

## 二、食物记录保存 500 与数据库结构

### 2.1 问题

- 前端 LogMeal 保存食物时请求 `POST /api/addFood` 返回 **500 Internal Server Error**。
- 后端日志：`Invalid object name 'FoodRecords'`（表不存在）；另有 EF 生成 `UserId1` 列导致与表结构不一致。

### 2.2 修改内容

- **SimpleFoodController.AddFood**
  - 捕获 `DbUpdateException` / `SqlException`（错误号 208，表不存在），调用 `EnsureFoodRecordsTableAsync` 自动创建 `FoodRecords` 表后重试插入。
  - 插入前清除 ChangeTracker 中失败的 `FoodRecord` 实体，避免重复添加。
- **ApplicationDbContext**
  - FoodRecord 与 ApplicationUser 关系由 `HasOne<ApplicationUser>()` 改为 `HasOne(f => f.User)`，消除 EF 生成的 **UserId1** 影子列。
- **迁移幂等化**
  - `20260128083515_AddUserNickname`：用条件 SQL `IF NOT EXISTS ... ADD [Nickname]`，避免 Nickname 列已存在时重复添加报错。
  - `20260202000000_AddFoodRecordsTable`：用条件 SQL `IF NOT EXISTS ... CREATE TABLE FoodRecords`，避免表已存在时报错。
- **MainPageController**
  - 对 FoodRecords 的查询包在 try-catch 中，若表不存在则忽略，避免 Dashboard 整页 500。

---

## 三、Azure 登录 500 与数据库缺列

### 3.1 问题

- 前端请求 Azure 后端 `POST .../api/Auth/login` 返回 **500**。
- 后端报错：`Invalid column name 'ContinuousNeutralDays'`、`Invalid column name 'LastNeutralDate'`（代码已更新，Azure 上数据库未执行新迁移）。

### 3.2 修改内容

- **新增迁移** `20260202160000_AddContinuousNeutralFieldsToApplicationUser`
  - 为 `ApplicationUsers` 表增加列：`ContinuousNeutralDays`（int，默认 0）、`LastNeutralDate`（datetime2，可空）。
- **Program.cs 启动时自动迁移**
  - 在 `app.Run()` 前增加 `using (var scope ...) { context.Database.Migrate(); }`，部署到 Azure 后启动时自动应用未执行迁移。
  - 后续改为 try-catch 包裹 `Migrate()`，失败时仅写日志不阻塞启动，便于排查。
- **手动补列脚本**（已删除）
  - 曾新增 `Migrations/fix-applicationusers-azure.sql`，在 Azure 查询编辑器中执行，为 `ApplicationUsers` 补齐 TotalCarbonEmission、StepsUsedToday、LastStepUsageDate、ContinuousNeutralDays、LastNeutralDate 等列；迁移成功后按用户要求删除该脚本及启动时 `Migrate()` 代码。

---

## 四、食物数量单位：克（g）→ 千克（kg）

- **约定**：前端统一传**克（g）**，后端除以 1000 得到 kg 再参与计算与存储。
- **SimpleFoodController**
  - `addFood`：`amountKg = req.Amount / 1000.0`，`emission = (decimal)amountKg * req.EmissionFactor`，落库为 kg。
  - `calculateFood`、`updateFood`：同样 `amountKg = req.Amount / 1000.0`，按 kg 计算排放，响应中 `amount` 为 kg。
- **DTO**
  - `AddFoodRequest`、`CalculateFoodRequest` 的 `amount` 注释为“克（g），后端 /1000 转为 kg”。

---

## 五、食物识别 / Vision 超时

- **appsettings.Development.json**：`Vision:TimeoutSeconds` 由 30 改为 **60**。
- **Program.cs**：Vision HttpClient 默认超时由 30 秒改为 **60** 秒（未配置时使用该默认值）。

---

## 六、前端与环境

- **Records 页面**
  - 拉取记录改为调用专用 API：`/api/FoodRecords/my-records`、`/api/Travel/my-travels`、`/api/UtilityBill/my-bills`，合并排序后展示；删除时按类型调用对应删除接口；通用 `RecordsController` 已删除。
- **LogMeal 保存**
  - 提交时调用 `POST /api/addFood`，配合后端自动建表与异常处理，修复保存 500。
- **Dashboard**
  - 统计范围保持“本月”；FoodRecords 查询包在 try-catch；Utility 仅统计 UtilityBills 的 TotalCarbonEmission。
- **.env.local**
  - 曾将 `VITE_API_URL` 改为 Azure 后端地址以便本地前端直连 Azure；并说明 CORS、500 与 JWT/DB 配置的排查方向。
- **前后端启停**
  - 使用 `start-all.ps1` 或单独启动后端（5133）、前端（5173）；关闭时结束占用 5133/5173 的进程。

---

## 七、部署

- **GitHub Actions**：`.github/workflows/dotnet-deploy.yml` 在向 `main` 推送且 `.NET/**` 变更时，构建并部署后端到 Azure Web App（ecolens-api）。
- **流程**：在 xuwenzhe 提交 → 合并到 main → `git push origin main` 触发部署；随后将 `origin/main` 合并回本地 xuwenzhe，保持分支同步。

---

## 八、迁移相关清理（迁移成功后）

- **删除**
  - `Migrations/fix-applicationusers-azure.sql`（手动补列脚本）。
- **Program.cs**
  - 移除启动时 `context.Database.Migrate()` 及对应 try-catch、日志；移除未使用的 `using Microsoft.Extensions.Logging`。
- **保留**
  - 所有 EF 迁移 `.cs` 文件（如 `20260202160000_AddContinuousNeutralFieldsToApplicationUser.cs`）仍保留，供 `dotnet ef database update` 及新环境使用。

---

## 九、总结

- **今日**：完成食物记录保存 500 的修复（FoodRecords 表自动创建、EF 关系修正、迁移幂等化）；解决 Azure 登录 500（缺列通过新迁移与启动 Migrate 补齐，随后移除 Migrate 与手动脚本）；统一食物数量为前端传克、后端转 kg；延长 Vision 超时至 60 秒；Records/Dashboard/LogMeal 与专用 API 及后端逻辑对齐；多次合并 main 与推送到 main，并完成迁移相关代码与脚本的清理。
- **文档**：本文档为当日多会话工作的汇总，便于后续查阅与交接。
