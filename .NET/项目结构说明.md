# EcoLens API 项目结构说明

## 📁 项目目录结构

```
.NET/EcoLens.Api/
├── Controllers/          # API 控制器层（处理 HTTP 请求）
│   ├── ActivityController.cs      # 活动记录相关接口
│   ├── AuthController.cs          # 用户认证接口（登录/注册）
│   ├── UserProfileController.cs   # 用户资料接口
│   ├── CommunityController.cs     # 社区功能接口
│   └── ...
│
├── Services/            # 业务逻辑服务层
│   ├── AuthService.cs            # 认证服务实现
│   └── IAuthService.cs           # 认证服务接口
│
├── Data/                # 数据访问层
│   └── ApplicationDbContext.cs   # EF Core 数据库上下文
│
├── Models/              # 数据模型（实体类）
│   ├── ApplicationUser.cs        # 用户实体
│   ├── ActivityLog.cs            # 活动日志实体
│   ├── CarbonReference.cs        # 碳排放参考数据
│   └── Enums/                    # 枚举类型
│
├── DTOs/                # 数据传输对象（API 输入/输出）
│   ├── Auth/                     # 认证相关 DTO
│   ├── Activity/                 # 活动相关 DTO
│   └── ...
│
├── Utilities/           # 工具类
│   ├── JwtOptions.cs            # JWT 配置选项
│   └── PasswordHasher.cs        # 密码加密工具
│
├── Program.cs           # 应用程序入口（配置依赖注入、中间件）
├── appsettings.json     # 配置文件（数据库连接、JWT 密钥等）
└── EcoLens.Api.csproj   # 项目文件（依赖包配置）
```

## 🏗️ 架构层次说明

### 1. **Controllers 层**（API 接口层）
- **职责**：接收 HTTP 请求，调用服务层，返回响应
- **特点**：使用 `[ApiController]`、`[Route]`、`[Authorize]` 等特性
- **示例**：`ActivityController` 处理活动相关的所有 API 请求

### 2. **Services 层**（业务逻辑层）
- **职责**：实现核心业务逻辑，可被多个控制器复用
- **特点**：通过依赖注入（DI）注入到控制器中
- **示例**：`AuthService` 处理用户注册、登录、JWT 生成等逻辑

### 3. **Data 层**（数据访问层）
- **职责**：数据库操作，通过 EF Core 进行 CRUD
- **特点**：`ApplicationDbContext` 管理所有数据库实体和关系
- **功能**：自动时间戳、实体关系配置、种子数据

### 4. **Models 层**（数据模型层）
- **职责**：定义数据库表结构对应的实体类
- **特点**：使用 Data Annotations 定义约束和关系
- **继承**：大部分实体继承 `BaseEntity`（包含 Id、CreatedAt、UpdatedAt）

### 5. **DTOs 层**（数据传输对象）
- **职责**：定义 API 的输入输出格式，与数据库实体分离
- **优势**：保护内部数据结构，只暴露必要字段给前端

## 🔄 数据流向

```
HTTP 请求 
  → Controller（验证、参数绑定）
    → Service（业务逻辑处理）
      → DbContext（数据库操作）
        → SQL Server
```

## 🔐 认证流程

1. 用户注册/登录 → `AuthController`
2. `AuthService` 验证用户信息
3. 生成 JWT Token 返回给前端
4. 后续请求在 Header 中携带 `Authorization: Bearer {token}`
5. `[Authorize]` 特性自动验证 Token

## 📝 关键配置

### Program.cs
- 注册依赖注入（Services、DbContext）
- 配置 CORS（跨域）
- 配置 JWT 认证
- 配置 Swagger（API 文档）

### appsettings.json
- 数据库连接字符串
- JWT 密钥和配置
- 日志级别

## 🗄️ 数据库关系

- `ApplicationUser` ←→ `ActivityLog`（一对多）
- `ApplicationUser` ←→ `Post`（一对多）
- `ActivityLog` → `CarbonReference`（多对一）
- `Post` ←→ `Comment`（一对多）
- `UserFollow`（自关联，实现关注功能）

---

## 🗺️ Google Maps API 集成方案

### 集成位置建议

Google Maps API 应该集成在 **Services 层**，创建一个新的服务类：

```
Services/
├── GoogleMapsService.cs      # Google Maps API 服务实现
└── IGoogleMapsService.cs     # Google Maps API 服务接口
```

### 使用场景示例

1. **地理编码**：将地址转换为经纬度
2. **反向地理编码**：将经纬度转换为地址
3. **路线规划**：计算两点间距离和路线
4. **地点搜索**：搜索附近的环保设施、充电桩等
5. **地图可视化**：在地图上显示用户活动位置

### 集成步骤

1. 安装 NuGet 包：`GoogleApi` 或使用 `HttpClient` 直接调用 REST API
2. 在 `appsettings.json` 中添加 Google Maps API Key
3. 创建 `GoogleMapsService` 服务类
4. 在 `Program.cs` 中注册服务
5. 在需要的 Controller 中注入并使用
